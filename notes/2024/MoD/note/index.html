<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>Mixture-of-Depths: Dynamically allocating compute in transformer-based language models - Efficient Paper</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css" rel="stylesheet" />
        <link href="../../../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Mixture-of-Depths: Dynamically allocating compute in transformer-based language models";
        var mkdocs_page_input_path = "notes/2024/MoD/note.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> Efficient Paper
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Paper List</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_year/">By Year</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_keyword/">By Keyword</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_publication/">By Publication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_institution/">By Institution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_author/">By Author</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Weekly Paper</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-07-25/">2025-07-25</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-01/">2025-08-01</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-08/">2025-08-08</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-15/">2025-08-15</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-22/">2025-08-22</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">Efficient Paper</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Mixture-of-Depths: Dynamically allocating compute in transformer-based language models</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
  
                <h1 id="mixture-of-depths-dynamically-allocating-compute-in-transformer-based-language-models">Mixture-of-Depths: Dynamically allocating compute in transformer-based language models</h1>
<p><a class="glightbox" href="../mod.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../mod.jpg" /></a></p>
<h2 id="abstract">Abstract</h2>
<p>Transformer-based language models spread FLOPs uniformly across input
sequences. In this work we demonstrate that transformers can instead learn to
dynamically allocate FLOPs (or compute) to specific positions in a sequence,
optimising the allocation along the sequence for different layers across the
model depth. Our method enforces a total compute budget by capping the number
of tokens (<script type="math/tex">k</script>) that can participate in the self-attention and MLP computations
at a given layer. The tokens to be processed are determined by the network
using a top-<script type="math/tex">k</script> routing mechanism. Since <script type="math/tex">k</script> is defined a priori, this simple
procedure uses a static computation graph with known tensor sizes, unlike other
conditional computation techniques. Nevertheless, since the identities of the
<script type="math/tex">k</script> tokens are fluid, this method can expend FLOPs non-uniformly across the
time and model depth dimensions. Thus, compute expenditure is entirely
predictable in sum total, but dynamic and context-sensitive at the token-level.
Not only do models trained in this way learn to dynamically allocate compute,
they do so efficiently. These models match baseline performance for equivalent
FLOPS and wall-clock times to train, but require a fraction of the FLOPs per
forward pass, and can be upwards of 50\% faster to step during post-training
sampling.</p>
<h2 id="method">Method</h2>
<h3 id="defining-a-compute-budget">Defining a compute budget</h3>
<p>å‡è®¾ä¸€å…±æœ‰Tä¸ªtokensè¾“å…¥åˆ°transformerä¸­è¿›è¡Œè¿ç®—ï¼Œæ­¤æ—¶çš„compute budgetåˆ™ä¸ºT. MoEæ–¹æ³•ç”±äºæœ‰å¤šä¸ªexpertsï¼Œä¸”å›é€‰æ‹©å…¶ä¸­ä¸€ä¸ªexpertè¿›è¡Œè¿ç®—ï¼Œæ‰€ä»¥å¹³å‡çš„compute budgetä¹Ÿçº¦ä¸ºTã€‚</p>
<p>å¯¹äºMoDæ¥è¯´ï¼Œç”±äºè¿™ä¸ªæ–¹æ³•ä¼šè·³è¿‡ä¸€äº›blockï¼Œæ‰€ä»¥æœ€ç»ˆçš„compute budgetä¼šå°äºTã€‚å‡è®¾ï¼Œå®šä¹‰æŸä¸€ä¸ªblockçš„compute budgetä¸º<script type="math/tex">T/2</script>ï¼Œé‚£ä¹ˆè¿™ä¸ªblockä¸­çš„self-attentionçš„flopsä¼šç”±ä¹‹å‰çš„<script type="math/tex">T^2</script>å˜ä¸º<script type="math/tex">\frac{T}{2}^2</script>ï¼Œä¹Ÿå°±æ˜¯å˜ä¸ºäº†åŸæ¥çš„25%ã€‚åŒç†ï¼Œå¯¹äºMLPï¼Œåˆ™ç”±åŸæ¥çš„<script type="math/tex">T</script>å˜ä¸º<script type="math/tex">\frac{T}{2}</script>ï¼Œå³åŸæ¥çš„50%ã€‚</p>
<h3 id="routing-schemes">Routing schemes</h3>
<p>Routingçš„æ–¹å¼å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§é€‰æ‹©
- éšæœºrouteï¼Œç±»ä¼¼dropoutï¼Œå¯¹performanceå½±å“å¾ˆå¤§
- learned routingï¼Œè¯æ˜æ˜¯æ¯”éšæœºroutingæ›´å¥½çš„æ–¹æ³•
    - token-choice routing
        - tokenå¯ä»¥é€‰æ‹©åˆé€‚çš„pathï¼Œä½†æ˜¯éœ€è¦å¼•å…¥balancing lossï¼Œä¸ç„¶æ‰€æœ‰çš„tokené€‰æ‹©çš„pathå®¹æ˜“è¶‹å‘ä¸ä¸€è‡´
        - ç”±äºæ²¡æœ‰å¼ºåˆ¶çš„çº¦æŸï¼Œtoken-choice routingä¼šå¯¼è‡´load unbalance
    - <strong>expert-choice routing</strong>
        - çº¦æŸæ¯ä¸ªpathæœ‰top-kçš„tokenæ¥é€‰æ‹©ï¼Œå¯ä»¥ä¿è¯load balance
        - ä½†æ˜¯ä¼šå¯¼è‡´æŸäº›tokenå®é™…è®¡ç®—é‡æ¯”æœ€ä¼˜éœ€æ±‚é«˜æˆ–è€…ä½ã€‚</p>
<p><a class="glightbox" href="../routing.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../routing.jpg" /></a>
å‰ä¸¤ä¸ªå›¾æ˜¯ä»¥MoEä¸ºä¾‹ï¼Œç¬¬ä¸‰ä¸ªå›¾åˆ™æ˜¯MoD routingçš„æ–¹æ³•ã€‚MoEä¸­æœ‰å¤šä¸ªexpertï¼Œtoken-choiceæ¯ä¸ªtokenå¯ä»¥é€‰æ‹©è‡ªå·±çš„expertï¼Œå¦‚å·¦1é€”ä¸­è™šçº¿æ‰€ç¤ºï¼Œå¦‚æœexpert1è¢«é€‰æ‹©çš„æ¬¡æ•°è¿‡å¤šï¼Œè¶…è¿‡äº†è®¾ç½®çš„capacityï¼Œåˆ™åªèƒ½æŠŠè¿™ä¸ªtokenç›´æ¥æ‰”æ‰ã€‚ä¸­é—´å›¾åˆ™é‡‡ç”¨äº†expert-choice æ–¹å¼ï¼Œæ¯ä¸ªexpertå¯¹åº”ä¸¤ä¸ªtokenï¼Œç”±äºæœ‰å¤šä¸ªexpertsï¼Œæ‰€ä»¥æŸäº›tokenå¯èƒ½ä¼šæœ‰å¤šä¸ªexpertï¼ŒæŸäº›tokenåˆ™å¯èƒ½ä¸€ä¸ªexpertéƒ½æ²¡æœ‰ï¼Œç›¸å½“äºä¸å‚ä¸è¿™ä¸ªblockè¿ç®—ã€‚å³å›¾åˆ™æ˜¯å¯¹MoDçš„routingï¼Œé€‰æ‹©åªæœ‰ä¸¤ç§ï¼Œè¦ä¹ˆå‚ä¸è¿ç®—ï¼Œè¦ä¹ˆä¸å‚ä¸è¿ç®—ï¼Œæ‰€ä»¥top-2çš„tokenä¼šå‚ä¸è¿™ä¸ªblockçš„è¿ç®—ï¼Œå…¶ä»–tokensåˆ™ä¼šç›´æ¥è·³è¿‡è¿™ä¸ªblockçš„è¿ç®—ã€‚</p>
<ul>
<li>æœ€ç»ˆï¼Œè®ºæ–‡é€‰æ‹©<strong>expert-choice routing</strong>ï¼Œå…·ä½“åŸå› ä¸ºï¼š<ul>
<li>ä¸éœ€è¦å¢åŠ balancing lossï¼Œæ—¢å¯ä»¥æ»¡è¶³load balance</li>
<li>Top-kçš„æ–¹æ³•å¯ä»¥æ‰¾åˆ°æœ€éœ€è¦å‚ä¸è¿ç®—çš„tokensï¼Œå…¶ä»–tokensåˆ™é€‰æ‹©è·³è¿‡è¿ç®—</li>
<li>é€‰æ‹©åªæœ‰ä¸¤ç§ï¼Œè®¡ç®—æˆ–è€…è·³è¿‡è®¡ç®—ï¼Œtop-kçš„æ–¹å¼å¯ä»¥å¾ˆå¥½çš„å®ç°è¿™ä¸ªé€‰æ‹©</li>
</ul>
</li>
</ul>
<h3 id="routing-implementation">Routing implementation</h3>
<p><a class="glightbox" href="../mod_routing.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../mod_routing.jpg" /></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé€‰æ‹©top-kçš„token embeddingè¿›è¡Œè¿ç®—ï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘compute budget
<a class="glightbox" href="../eq1.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../eq1.jpg" /></a>
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„blockçš„è¾“å‡º<script type="math/tex">f_i(x)</script>å¢åŠ äº†ä¸<script type="math/tex">r_i</script>ä½œä¸ºæƒé‡ã€‚</p>
<h3 id="non-causal-problem-during-sampling">Non-causal problem during sampling</h3>
<p>åœ¨è‡ªå›å½’samplingæ—¶ï¼Œç¡®å®šè¿™ä¸ªtokenæ˜¯å¦åœ¨top-kä¸­ï¼Œéœ€è¦ä¸æœªæ¥çš„tokenè¿›è¡Œæ¯”è¾ƒï¼Œä½†æ˜¯æ— æ³•è·å–æœªæ¥çš„tokenï¼Œå¯¼è‡´å› æœé€»è¾‘æ··ä¹±ã€‚è®ºæ–‡ä¸­ç»™å‡ºäº†ä¸¤ä¸ªè§£å†³æ–¹æ³•ï¼š
- A simple auxiliary loss
    - ä½¿ç”¨binary cross-entropy lossæ¥åŒºåˆ†æ¯ä¸ªtokençš„<script type="math/tex">r_i</script>æ˜¯å¦å±äºtopk
- A small auxiliary MLP predictor
    - ç›¸å½“äºsecond routerï¼Œç”¨äºé¢„æµ‹æ˜¯å¦å±äºtopk</p>
<h3 id="training">Training</h3>
<p>Trainingéƒ¨åˆ†æ‰€æœ‰çš„è¶…å‚æ•°ä¿æŒä¸å˜ï¼Œåªä¿®æ”¹äº†layer numberï¼Œheadså’Œembedding sizeç­‰</p>
<h2 id="results">Results</h2>
<p><a class="glightbox" href="../fig3.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../fig3.jpg" /></a>
åŒç­‰å‚æ•°é‡ä¸‹ï¼ŒMoDæ¯”baselineè¦å¿«ï¼ŒåŒç­‰è®­ç»ƒflopså’Œwall-clockä¸‹ï¼Œè®­ç»ƒç»“æœç›¸ä¼¼ï¼›ï¼ˆä¹Ÿå°±æ˜¯è¯´MoDéœ€è¦è®­ç»ƒæ›´å¤šçš„iterationï¼‰ </p>
<p>Every block routing å’Œ <strong>Evary other block routing</strong>å¯¹æ¯”ï¼Œåè€…è¡¨ç°æ›´å¥½ã€‚</p>
<p><a class="glightbox" href="../fig4.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../fig4.jpg" /></a></p>
              
  <!-- Giscusåªåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¾ç¤ºï¼Œæœ¬åœ°å¼€å‘æ—¶éšè— -->

<div style="padding: 20px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; margin: 20px 0;">
    <p><strong>ğŸ“ è¯„è®ºåŠŸèƒ½</strong></p>
    <p>è¯„è®ºåŠŸèƒ½ä»…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨ã€‚åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­ï¼ŒGiscus æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
    <p>è¯·è®¿é—®çº¿ä¸Šç‰ˆæœ¬æŸ¥çœ‹å®Œæ•´çš„è¯„è®ºåŠŸèƒ½ã€‚</p>
</div>


            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
      <script src="../../../../js/prism-prototxt.js"></script>
      <script src="../../../../js/preview.js"></script>
      <script src="../../../../js/back-to-top.js"></script>
      <script src="https://giscus.app/client.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
