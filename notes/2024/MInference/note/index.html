<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>MInference 1.0: Accelerating Pre-filling for Long-Context LLMs via Dynamic Sparse Attention - Efficient Paper</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css" rel="stylesheet" />
        <link href="../../../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "MInference 1.0: Accelerating Pre-filling for Long-Context LLMs via Dynamic Sparse Attention";
        var mkdocs_page_input_path = "notes/2024/MInference/note.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> Efficient Paper
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Paper List</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_year/">By Year</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_keyword/">By Keyword</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_publication/">By Publication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_institution/">By Institution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_author/">By Author</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Weekly Paper</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-07-25/">2025-07-25</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-01/">2025-08-01</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-08/">2025-08-08</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-15/">2025-08-15</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-22/">2025-08-22</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">Efficient Paper</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">MInference 1.0: Accelerating Pre-filling for Long-Context LLMs via Dynamic Sparse Attention</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
  
                <h1 id="minference-10-accelerating-pre-filling-for-long-context-llms-via-dynamic-sparse-attention">MInference 1.0: Accelerating Pre-filling for Long-Context LLMs via Dynamic Sparse Attention</h1>
<h2 id="abstract">Abstract</h2>
<p>The computational challenges of Large Language Model (LLM) inference remain a
significant barrier to their widespread deployment, especially as prompt
lengths continue to increase. Due to the quadratic complexity of the attention
computation, it takes 30 minutes for an 8B LLM to process a prompt of 1M tokens
(i.e., the pre-filling stage) on a single A100 GPU. Existing methods for
speeding up prefilling often fail to maintain acceptable accuracy or efficiency
when applied to long-context LLMs. To address this gap, we introduce MInference
(Milliontokens Inference), a sparse calculation method designed to accelerate
pre-filling of long-sequence processing. Specifically, we identify three unique
patterns in long-context attention matrices-the A-shape, Vertical-Slash, and
Block-Sparsethat can be leveraged for efficient sparse computation on GPUs. We
determine the optimal pattern for each attention head offline and dynamically
build sparse indices based on the assigned pattern during inference. With the
pattern and sparse indices, we perform efficient sparse attention calculations
via our optimized GPU kernels to significantly reduce the latency in the
pre-filling stage of long-context LLMs. Our proposed technique can be directly
applied to existing LLMs without any modifications to the pre-training setup or
additional fine-tuning. By evaluating on a wide range of downstream tasks,
including InfiniteBench, RULER, PG-19, and Needle In A Haystack, and models
including LLaMA-3-1M, GLM4-1M, Yi-200K, Phi-3-128K, and Qwen2-128K, we
demonstrate that MInference effectively reduces inference latency by up to 10x
for pre-filling on an A100, while maintaining accuracy. Our code is available
at https://aka.ms/MInference.</p>
<p>MInference é’ˆå¯¹prefillé˜¶æ®µ long-contextåœºæ™¯ï¼Œåˆ©ç”¨attentionçš„è¿ç®—åŠ¨æ€ç¨€ç–è¡Œè¿›è¡ŒåŠ é€Ÿã€‚</p>
<p><a class="glightbox" href="../qk_atten.PNG" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../qk_atten.PNG" /></a></p>
<p>è®ºæ–‡ä¸­å°†attention ä¸­sparseçš„ç¨€ç–åˆ†ä¸ºä¸‰ç§æ¨¡å¼ï¼š</p>
<p><a class="glightbox" href="../MInference_3shape.PNG" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../MInference_3shape.PNG" /></a>
1. A-shapeçš„æ¨¡å¼ï¼Œåªä¿ç•™æœ€å¼€å§‹å‡ åˆ—å’Œæœ€è¿‘çš„å‡ åˆ—è¿ç®—ï¼Œå› æ­¤ä¹Ÿæ˜¯é™æ€çš„sparseï¼Œç›´æ¥å¯ä»¥å‡å°‘è¿ç®—å¼€é”€ï¼›
2. Vertial-slash æ¨¡å¼ï¼Œå¦‚åç§°å«ä¹‰ä¸€æ ·ï¼Œç«–ç€ä¿ç•™å‡ åˆ—ï¼Œæ–œç€ä¿ç•™å‡ åˆ—ï¼ŒåŒæ—¶sparse indexéœ€è¦æ ¹æ®è¾“å…¥æ¥åŠ¨æ€çš„ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥å‡å°‘è¿ç®—ï¼›
3. Block-sparseæ¨¡å¼ï¼ŒæŒ‰ç…§blockç²’åº¦æ¥é€‰æ‹©ä¸€éƒ¨åˆ†blockè¿›è¡Œç¨€ç–è¿ç®—ï¼›</p>
<p>åŠ é€Ÿå®ç°ï¼š
attentionä¸€èˆ¬æœ‰å¤šä¸ªheadï¼Œæ–‡ä¸­é¦–å…ˆä½¿ç”¨ä¸€å°éƒ¨åˆ†sample æ¥å¯¹attention headè¿›è¡Œè¯„ä¼°ï¼Œç¡®å®šæ¯ä¸ªheadé€‰æ‹©ä¸‰ç§ç¨€ç–æ¨¡å¼çš„å…¶ä¸­ä¸€ç§ï¼›</p>
<p>å…¶æ¬¡ï¼Œå¯¹åº”ä¸‰ç§ç¨€ç–æ¨¡å¼çš„åŠ é€Ÿå®ç°
1. A-shapeæ¨¡å¼ï¼Œç”±äºæ˜¯é™æ€çš„sparseï¼Œæ‰€ä»¥åŠ é€Ÿå®ç°æ¯”è¾ƒç›´æ¥ï¼›
2. Vertial-slash æ¨¡å¼ï¼Œéœ€è¦åŠ¨æ€çš„å†³å®šä¿ç•™çš„indexï¼Œä¼šæœ‰é¢å¤–çš„è¯„ä¼°çš„å¼€é”€ï¼ŒsparseåŠ é€Ÿéƒ¨åˆ†éœ€è¦å®ç°å¯¹åº”attention kernelè¿›è¡ŒåŠ é€Ÿï¼›
3. Block-sparseæ¨¡å¼ï¼ŒåŒæ ·éœ€è¦åŠ¨æ€å†³å®šä¿ç•™çš„block indexï¼Œä¼šå¼•å…¥é¢å¤–çš„è¯„ä¼°å¼€é”€ï¼ŒåŒæ—¶sparseåŠ é€Ÿä¹Ÿéœ€è¦å¯¹åº”çš„attention kernelã€‚</p>
<p>ç”±äºæ¨¡å¼2å’Œ3å‡å¼•å…¥äº†é¢å¤–çš„runtimeçš„è¯„ä¼°å¼€é”€ï¼Œè¿™éƒ¨åˆ†å¼€é”€è¦å°½å¯èƒ½é«˜æ•ˆï¼Œè®¾è®¡å¦‚ä¸‹ï¼š
<a class="glightbox" href="../alg.PNG" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../alg.PNG" /></a></p>
<ol>
<li>Vertial-slash æ¨¡å¼çš„è¯„ä¼°å¼€é”€ä¸»è¦ä¸ºæœ€åä¸€è¡ŒQæ¶‰åŠçš„è¿ç®—</li>
<li>Block-sparseæ¨¡å¼çš„è¯„ä¼°å¼€é”€ä¸»è¦ä¸ºPoolä¹‹åçš„ç¼©å°åçš„QKæ¶‰åŠçš„è¿ç®—
å¯ä»¥å‘ç°ï¼Œè¿™éƒ¨åˆ†è¯„ä¼°å¼€é”€ç›¸è¾ƒäºdense attentionè¿ç®—æ˜¯éå¸¸å°çš„ï¼Œå½“è·å–åˆ°å½“å‰çš„åŠ¨æ€sparse maskåï¼Œä½¿ç”¨å¯¹åº”çš„sparse attention kernelä¾¿å¯ä»¥è¿›è¡ŒåŠ é€Ÿã€‚</li>
</ol>
<p>å®éªŒéƒ¨åˆ†ï¼š
ç²¾åº¦ç»“æœï¼š
ç”±äºåŠ é€Ÿæ¥æºäºè·³è¿‡äº†ä¸€éƒ¨åˆ†è¿ç®—ï¼Œä¸”è¯„ä¼°è·³è¿‡çš„ä½ç½®å¯èƒ½ä¼šå­˜åœ¨ä¸å®é™…ç¨€ç–ä½ç½®æœ‰åå·®çš„æƒ…å†µï¼Œæ‰€ä»¥æ¨¡å‹çš„ç²¾åº¦ä¼šå—åˆ°ä¸€å®šçš„å½±å“ï¼Œæ–‡ä¸­ä½¿ç”¨InfiniteBenchè¿›è¡Œäº†å¯¹æ¯”ï¼Œå¯ä»¥å‘ç°ç²¾åº¦ç›¸è¾ƒäºbaselineç¡®å®æœ‰ä¸€äº›æ³¢åŠ¨ï¼Œä½†æ˜¯å¹³å‡æ­£ç¡®ç‡æ²¡æœ‰ä¸‹é™ï¼Œè¿™ä¹Ÿè¯æ˜äº†æ–¹æ³•çš„é²æ£’æ€§ã€‚</p>
<p><a class="glightbox" href="../res.PNG" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../res.PNG" /></a></p>
<p>åŠ é€Ÿç»“æœï¼š
å¯ä»¥çœ‹åˆ°éšç€context sizeæå‡ï¼Œæœ€é«˜èƒ½æœ‰10å€çš„åŠ é€Ÿã€‚</p>
<p><a class="glightbox" href="../res1.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../res1.png" /></a></p>
              
  <!-- Giscusåªåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¾ç¤ºï¼Œæœ¬åœ°å¼€å‘æ—¶éšè— -->

<div style="padding: 20px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; margin: 20px 0;">
    <p><strong>ğŸ“ è¯„è®ºåŠŸèƒ½</strong></p>
    <p>è¯„è®ºåŠŸèƒ½ä»…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨ã€‚åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­ï¼ŒGiscus æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
    <p>è¯·è®¿é—®çº¿ä¸Šç‰ˆæœ¬æŸ¥çœ‹å®Œæ•´çš„è¯„è®ºåŠŸèƒ½ã€‚</p>
</div>


            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
      <script src="../../../../js/prism-prototxt.js"></script>
      <script src="../../../../js/preview.js"></script>
      <script src="../../../../js/back-to-top.js"></script>
      <script src="https://giscus.app/client.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
