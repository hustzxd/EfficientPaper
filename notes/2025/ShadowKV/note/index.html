<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../../img/favicon.ico" />
    <title>ShadowKV: KV Cache in Shadows for High-Throughput Long-Context LLM Inference - Efficient Paper</title>
    <link rel="stylesheet" href="../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css" rel="stylesheet" />
        <link href="../../../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "ShadowKV: KV Cache in Shadows for High-Throughput Long-Context LLM Inference";
        var mkdocs_page_input_path = "notes/2025/ShadowKV/note.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../.." class="icon icon-home"> Efficient Paper
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Paper List</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_year/">By Year</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_keyword/">By Keyword</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_publication/">By Publication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_institution/">By Institution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../cls_author/">By Author</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Weekly Paper</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-07-25/">2025-07-25</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-01/">2025-08-01</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-08/">2025-08-08</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-15/">2025-08-15</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../../weekly_paper/2025-08-22/">2025-08-22</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../..">Efficient Paper</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">ShadowKV: KV Cache in Shadows for High-Throughput Long-Context LLM Inference</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
  
                <h1 id="shadowkv-kv-cache-in-shadows-for-high-throughput-long-context-llm-inference">ShadowKV: KV Cache in Shadows for High-Throughput Long-Context LLM Inference</h1>
<p><a class="glightbox" href="../shadowkv.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../shadowkv.png" /></a></p>
<h2 id="abstract">Abstract</h2>
<p>With the widespread deployment of long-context large language models (LLMs),
there has been a growing demand for efficient support of high-throughput
inference. However, as the key-value (KV) cache expands with the sequence
length, the increasing memory footprint and the need to access it for each
token generation both result in low throughput when serving long-context LLMs.
While various dynamic sparse attention methods have been proposed to speed up
inference while maintaining generation quality, they either fail to
sufficiently reduce GPU memory consumption or introduce significant decoding
latency by offloading the KV cache to the CPU. We present ShadowKV, a
high-throughput long-context LLM inference system that stores the low-rank key
cache and offloads the value cache to reduce the memory footprint for larger
batch sizes and longer sequences. To minimize decoding latency, ShadowKV
employs an accurate KV selection strategy that reconstructs minimal sparse KV
pairs on-the-fly. By evaluating ShadowKV on a broad range of benchmarks,
including RULER, LongBench, and Needle In A Haystack, and models like
Llama-3.1-8B, Llama-3-8B-1M, GLM-4-9B-1M, Yi-9B-200K, Phi-3-Mini-128K, and
Qwen2-7B-128K, we demonstrate that it can support up to 6<script type="math/tex">\times</script> larger batch
sizes and boost throughput by up to 3.04<script type="math/tex">\times</script> on an A100 GPU without
sacrificing accuracy, even surpassing the performance achievable with infinite
batch size under the assumption of infinite GPU memory. The code is available
at https://github.com/bytedance/ShadowKV.</p>
<h2 id="observation">ä¸¤ä¸ª Observation</h2>
<ul>
<li>Pre-RoPE keys å¯ä»¥é€šè¿‡SVDåˆ†è§£æ–¹å¼ï¼Œå‹ç¼©6å€ï¼Œä¸”æ²¡æœ‰ç²¾åº¦æŸå¤±</li>
<li>Post-RePE keys é‚»è¿‘ tokenså…·æœ‰ç›¸ä¼¼æ€§ï¼Œå»é™¤ä¸€äº›outlieråï¼Œå¹¶æŒ‰ç…§chunkå¯¹å…¶è¿›è¡Œmean reduceï¼Œè§‚å¯Ÿåˆ°éå¸¸å¥½çš„ cosine ç›¸ä¼¼åº¦ï¼Œå› æ­¤æŠŠmean reduceåçš„key å½“ä½œ landmarks</li>
</ul>
<h2 id="shadowkv">ShadowKV</h2>
<h3 id="pre-filling">Pre-filling</h3>
<p><a class="glightbox" href="../fig4.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../fig4.png" /></a></p>
<ul>
<li>å¯¹Pre-RoPEçš„Kè¿›è¡ŒSVDåˆ†è§£ï¼Œ</li>
<li>å¯¹Post-RoPEçš„K æŒ‰ç…§chunkè¿›è¡Œåˆ†ç»„ï¼Œæ¯ç»„ä¿ç•™mean</li>
<li>å¦‚æœç»„å†…çš„ cosine ç›¸ä¼¼åº¦å¾ˆä½ï¼Œé‚£ä¹ˆè¿™ç»„ä½œä¸ºoutlieræ¥å•ç‹¬ä¿å­˜ã€‚</li>
</ul>
<h3 id="decoding">Decoding</h3>
<p><a class="glightbox" href="../fig5.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../fig5.png" /></a></p>
<ul>
<li>æ ¹æ®Kçš„landmarkä¸Qè¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°softmaxçš„scoreï¼Œ</li>
<li>é€‰æ‹©æœ€é«˜çš„å‡ ä¸ªscoreå¯¹åº”çš„indexï¼Œæ ¹æ®indexé€‰æ‹©ç¨€ç–V</li>
<li>æ ¹æ®indexå’Œprefillä¿å­˜çš„SVDå°çŸ©é˜µï¼Œåˆå¹¶ä¸ºç¨€ç–K</li>
<li>æ˜¯å¦éœ€è¦æ ¹æ®sparse K sparse Vè®¡ç®—attention? åº”è¯¥æ˜¯éœ€è¦çš„ï¼Œç®—æ³•å†™çš„æœ‰äº›ä¸å®Œæ•´</li>
</ul>
<p>æ‰€æœ‰çš„Véƒ½ä¿å­˜ä¸‹æ¥äº†ï¼ŒKçš„SVDåˆ†è§£å…¶å®ä¹Ÿå¯ä»¥ä¸åšï¼Œä¹Ÿå¯ä»¥åƒVä¸€æ ·å­˜åœ¨CPU Memoyä¸­ï¼Œæ ¹æ®landmarkè¿›è¡Œè®¡ç®—ï¼›é™¤äº†SVDåˆ†è§£çš„æ€è·¯ï¼Œlandmarkçš„æ€æƒ³å…¶å®å’ŒMInferenceæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡é—´éš”çš„è®¡ç®—æ¥è¯„ä¼°å“ªéƒ¨åˆ†çš„kvé‡è¦ï¼Œä»è€Œå°†dense attentionè½¬åŒ–ä¸º sparse attentionï¼Œè¿›è€ŒåŠ é€Ÿæ•´ä¸ªè®¡ç®—è¿‡ç¨‹ã€‚</p>
<p>Kçš„ä¸´è¿‘ç›¸ä¼¼ç›¸å’Œå¯ä»¥åˆ†è§£çš„ç‰¹æ€§ã€‚</p>
              
  <!-- Giscusåªåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¾ç¤ºï¼Œæœ¬åœ°å¼€å‘æ—¶éšè— -->

<div style="padding: 20px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; margin: 20px 0;">
    <p><strong>ğŸ“ è¯„è®ºåŠŸèƒ½</strong></p>
    <p>è¯„è®ºåŠŸèƒ½ä»…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨ã€‚åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­ï¼ŒGiscus æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
    <p>è¯·è®¿é—®çº¿ä¸Šç‰ˆæœ¬æŸ¥çœ‹å®Œæ•´çš„è¯„è®ºåŠŸèƒ½ã€‚</p>
</div>


            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../../..";</script>
    <script src="../../../../js/theme_extra.js"></script>
    <script src="../../../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
      <script src="../../../../js/prism-prototxt.js"></script>
      <script src="../../../../js/preview.js"></script>
      <script src="../../../../js/back-to-top.js"></script>
      <script src="https://giscus.app/client.js"></script>
      <script src="../../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
